name: CI
on:
  push:
    branches: [main]
  pull_request:
permissions:
  contents: read

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  quality:
    name: Lint / pre-commit / security (matrix)
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ "3.11", "3.12" ]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
          key: "${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('poetry.lock', 'pyproject.toml') }}"
          restore-keys: |
             ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          pip install poetry
          poetry install --with dev --no-root --no-interaction

      - name: Lint & Format
        run: |
          poetry run ruff check --output-format=github .
          poetry run black --check .
          poetry run isort --check-only .

      - name: Pre-commit (all files)
        run: poetry run pre-commit run --all-files

      - name: pip-audit
        run: |
          poetry run pip-audit \
            --strict \
            --ignore-vuln GHSA-wj6h-64fc-37mp

  integration:
    name: Docker compose / Vault / tests / reports
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (tooling)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip (tooling)
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: "${{ runner.os }}-tooling-${{ hashFiles('poetry.lock', 'pyproject.toml') }}"
          restore-keys: |
            ${{ runner.os }}-tooling-

      - name: Generate runtime .env from CI secrets
        id: gen
        shell: bash
        run: |
          set -e
          cat > .env <<EOF
          JWT_SECRET=${{ secrets.CI_JWT_SECRET }}
          PYTHONUNBUFFERED=1
          VAULT_ADDR=${{ vars.CI_VAULT_ADDR }}
          VAULT_DEV_ROOT_TOKEN_ID=${{ secrets.CI_VAULT_DEV_ROOT_TOKEN }}
          VAULT_TOKEN=root
          APP_VAULT_TOKEN=root
          DB_DSN=${{ secrets.CI_DB_DSN }}
          POSTGRES_DB=${{ vars.CI_POSTGRES_DB }}
          POSTGRES_USER=${{ vars.CI_POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.CI_POSTGRES_PASSWORD }}
          EOF

      - name: Start Vault + DB + init
        run: |
          docker compose --env-file .env up -d vault db
          docker compose --env-file .env up -d vault-init

      - name: Wait for vault-init
        run: |
          set -e
          for i in $(seq 1 60); do
            cstate=$(docker inspect -f '{{.State.Status}}' vault-init 2>/dev/null || true)
            if [ "$cstate" = "exited" ]; then
              exit_code=$(docker inspect -f '{{.State.ExitCode}}' vault-init)
              if [ "$exit_code" = "0" ]; then
                echo "vault-init done"
                break
              else
                echo "vault-init failed"
                docker logs vault-init
                exit 1
              fi
            fi
            sleep 1
          done
          if [ "$cstate" != "exited" ]; then
            echo "vault-init did not finish in time"
            docker logs vault-init || true
            exit 1
          fi

      - name: Check user inside container (id -u != 0)
        shell: bash
        run: |
          set -e
          CONTAINER_UID=$(docker compose run --rm --no-deps app id -u)
          echo "Container UID is $CONTAINER_UID"
          if [ "$CONTAINER_UID" -eq 0 ]; then
            echo "ERROR: container runs as root"
            exit 1
          fi

      - name: Hadolint on Dockerfile
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile > hadolint-report.txt
          if [ ! -s hadolint-report.txt ]; then
            echo "Hadolint: no issues found." > hadolint-report.txt
          fi

      - name: Trivy
        run: |
          docker compose build app
          docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image \
          --format json \
          --output trivy-report.json \
          course-project-grantus-app

      - name: Deploy app container (mock staging)
        run: docker compose --env-file .env up -d app

      - name: Wait for app to become healthy
        shell: bash
        run: |
          set -e
          docker compose up -d app
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' okr-service-app)
            echo "Health status: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "Container is healthy"
              break
            fi
            if [ "$STATUS" = "unhealthy" ]; then
              echo "Container is unhealthy"
              docker compose logs app
              exit 1
            fi
            sleep 2
          done
          STATUS=$(docker inspect --format='{{.State.Health.Status}}' okr-service-app)
          if [ "$STATUS" != "healthy" ]; then
            echo "Timed out waiting for healthy (status: $STATUS)"
            docker compose logs app
            exit 1
          fi

      - name: Tests
        run: docker compose --env-file .env run --rm tests

      - name: Generate SBOM (CycloneDX)
        run: |
          pip install cyclonedx-bom
          cyclonedx-py poetry . --of json -o sbom.json

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-reports
          path: |
            hadolint-report.txt
            trivy-report.json
            sbom.json

      - name: Cleanup docker compose
        if: always()
        run: docker compose down -v
