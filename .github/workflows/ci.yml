name: CI
on:
  pull_request:
  push:
    branches: [main]
permissions:
  contents: read
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate runtime secrets
        id: gen
        run: |
          set -e
          JWT_SECRET=$(python -c "import secrets; print(secrets.token_hex(32))")
          APP_VAULT_TOKEN=root

          {
            echo "JWT_SECRET=${JWT_SECRET}"
            echo "APP_VAULT_TOKEN=${APP_VAULT_TOKEN}"
          } > .env

      - name: Start Vault + DB + init
        run: |
          docker compose --env-file .env up -d vault db
          docker compose --env-file .env up -d vault-init

      - name: Wait for vault-init
        run: |
          for i in $(seq 1 60); do
            cstate=$(docker inspect -f '{{.State.Status}}' vault-init 2>/dev/null || true)
            if [ "$cstate" = "exited" ]; then
              exit_code=$(docker inspect -f '{{.State.ExitCode}}' vault-init)
              if [ "$exit_code" = "0" ]; then
                echo "vault-init done"
                break
              else
                echo "vault-init failed"
                docker logs vault-init
                exit 1
              fi
            fi
            sleep 1
          done

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Lint & Format
        run: |
          ruff check --output-format=github .
          black --check .
          isort --check-only .

      - name: Tests
        env:
          PYTHONUNBUFFERED: "1"
          VAULT_ADDR: http://vault:8200
          VAULT_TOKEN: root
          DB_DSN: postgresql://app:app@db:5432/app
        run: docker compose --env-file .env run --rm tests

      - name: Pre-commit (all files)
        run: pre-commit run --all-files

      - name: pip-audit
        run: |
          python -m pip install --upgrade pip-audit
          pip-audit -r requirements.txt
      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-py requirements requirements.txt --of JSON -o sbom.json
