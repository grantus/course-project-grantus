name: CI
on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VAULT_ADDR: http://localhost:8200
      VAULT_TOKEN: root

    steps:
      - uses: actions/checkout@v4

      - name: Generate runtime secrets
        id: gen
        run: |
          set -e
          JWT_SECRET=$(python3 -c "import secrets; print(secrets.token_hex(32))")
          PYTHONUNBUFFERED=1
          VAULT_ADDR=http://vault:8200
          VAULT_DEV_ROOT_TOKEN_ID=root
          VAULT_TOKEN=root
          APP_VAULT_TOKEN=root
          DB_DSN=postgresql://app:app@db:5432/app
          POSTGRES_DB=app
          POSTGRES_USER=app
          POSTGRES_PASSWORD=app

          cat > .env <<EOF
          JWT_SECRET=${JWT_SECRET}
          PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
          VAULT_ADDR=${VAULT_ADDR}
          VAULT_DEV_ROOT_TOKEN_ID=${VAULT_DEV_ROOT_TOKEN_ID}
          VAULT_TOKEN=${VAULT_TOKEN}
          APP_VAULT_TOKEN=${APP_VAULT_TOKEN}
          DB_DSN=${DB_DSN}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          EOF

      - name: Start Vault + DB + init
        run: |
          docker compose --env-file .env up -d vault db
          docker compose --env-file .env up -d vault-init

      - name: Wait for vault-init
        run: |
          for i in $(seq 1 60); do
            cstate=$(docker inspect -f '{{.State.Status}}' vault-init 2>/dev/null || true)
            if [ "$cstate" = "exited" ]; then
              exit_code=$(docker inspect -f '{{.State.ExitCode}}' vault-init)
              if [ "$exit_code" = "0" ]; then
                echo "vault-init done"
                break
              else
                echo "vault-init failed"
                docker logs vault-init
                exit 1
              fi
            fi
            sleep 1
          done

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install pip (safe)
        run: python -m pip install --upgrade "pip!=25.2"

      - name: Install dependencies
        run: |
          pip install poetry
          poetry install --with dev --no-root --no-interaction

      - name: Start Vault (dev)
        run: |
          docker run -d --rm --name vault -p 8200:8200 \
            -e VAULT_DEV_ROOT_TOKEN_ID=root \
            hashicorp/vault:1.16 \
            server -dev -dev-root-token-id=root -dev-listen-address=0.0.0.0:8200

      - name: Wait for Vault API
        run: |
          for i in {1..120}; do
            if curl -sf http://localhost:8200/v1/sys/health | grep -q '"initialized":true'; then
              echo "Vault API is up"; break
            fi
            echo "Waiting for Vault... ($i/120)"; sleep 1
          done

      - name: Enable KV v2 and write secret
        run: |
          docker exec vault sh -lc '
            export VAULT_ADDR=http://127.0.0.1:8200 VAULT_TOKEN=root &&
            vault secrets disable secret || true &&
            vault secrets enable -path=kv -version=2 kv &&
            vault kv put kv/jwt JWT_SECRET="super_secret_key"
          '

      - name: Verify secret exists (HTTP)
        run: |
          for i in {1..60}; do
            if curl -sf -H "X-Vault-Token: ${VAULT_TOKEN}" http://localhost:8200/v1/kv/data/jwt >/dev/null; then
              echo "Secret kv/jwt is readable"; break
            fi
            echo "Waiting for kv/jwt... ($i/60)"; sleep 1
          done

      - name: Lint & Format
        run: |
          poetry run ruff check --output-format=github .
          poetry run black --check .
          poetry run isort --check-only .

      - name: Check user inside container (id -u != 0)
        run: |
          CONTAINER_UID=$(docker compose run --rm --no-deps app id -u)
          echo "Container CONTAINER_UID is CONTAINER_UID"
          if [ "CONTAINER_UID" -eq 0 ]; then
            echo "ERROR: container runs as root"
            exit 1
          fi

      - name: Hadolint on Dockerfile
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile > hadolint-report.txt
          if [ ! -s hadolint-report.txt ]; then
            echo "Hadolint: no issues found." > hadolint-report.txt
          fi

      - name: Trivy
        run: |
          docker compose build app
          docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image \
          --format json \
          --output trivy-report.json \
          course-project-grantus-app
      - name: Wait for app to become healthy
        run: |
          docker compose up -d app

          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' okr-service-app)
            echo "Health status: $STATUS"

            if [ "$STATUS" = "healthy" ]; then
              echo "Container is healthy"
              break
            fi

            if [ "$STATUS" = "unhealthy" ]; then
              echo "Container is unhealthy"
              docker compose logs app
              exit 1
            fi

            sleep 2
          done

          STATUS=$(docker inspect --format='{{.State.Health.Status}}' okr-service-app)
          if [ "$STATUS" != "healthy" ]; then
            echo "Timed out waiting for healthy (status: $STATUS)"
            docker compose logs app
            exit 1
          fi

      - name: Tests
        run: docker compose --env-file .env run --rm tests

      - name: Pre-commit
        run: poetry run pre-commit run --all-files

      - name: pip-audit
        run: |
          poetry run pip-audit \
            --strict \
            --ignore-vuln GHSA-wj6h-64fc-37mp

      - name: Generate SBOM
        run: |
          pip install cyclonedx-bom
          cyclonedx-py poetry . --of json -o sbom.json
