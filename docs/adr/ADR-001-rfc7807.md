# ADR-001: Ошибки в формате RFC 7807 (+ correlation_id)
Дата: 2025-10-23
Статус: Accepted

## Context
По NFR требуется единый формат ошибок RFC 7807 без PII и с `correlation_id`, чтобы упростить приёмку, трассировку и аудит.

## Decision
- Глобальные exception-handlers возвращают application/problem+json с полями: `type`, `title`, `status`, `detail`, `correlation_id`.
- `correlation_id` — UUIDv4 на каждую ошибку; тот же id пишется в audit-логах.
- Маскирование технических деталей (stacktrace, SQL, PII) во всех ошибках.
- Карта типов: validation → `…/problems/validation-error`, auth/authz → `…/problems/auth-error`, rate-limit → `…/problems/rate-limit`.
- Конвертация `HTTPException`, доменных `ApiError` и `RateLimitExceeded` в RFC7807 (через общий helper `problem(...)`).

### Public read policy
Так как GET публичные, соблюдаем минимизацию данных: публичная модель не содержит PII/секретов (только title/metric/progress). Owner-only применяется только к записным операциям.

## Alternatives
- Дефолтные ответы FastAPI (разный формат, риск утечек) — отказ.
- Произвольный JSON-формат (хуже совместимость) — отказ.
- Только логирование без стандартизации — отказ.

## Consequences
Плюсы: единый контракт для клиентов и тестов; трассировка инцидентов по `correlation_id`.
Минусы: нужен мэппинг исключений → коды/типы.

## Security impact
Снижение риска утечки деталей ошибок; улучшение трассы/аудита. Публичные GET безопасны за счёт минимизации данных.

## Rollout plan / DoD
- Feature-flag `FEATURE_PROBLEM_DETAILS=true`; canary 5% трафика.
- DoD: 100% ошибок — RFC7807 + `correlation_id`; в логах присутствует тот же id; контракт-тесты зелёные.

## Links
- NFR-05 (RFC7807), NFR-09 (аудит/трасса).
- RISKS: R7 — «утечка PII/деталей стека в ошибках» (смягчаем маскированием и единым форматом RFC7807); R12 — «нет трассировки действий» (закрываем `correlation_id` + audit-лог).
- Тесты: `tests/test_errors_rfc7807.py::assert_problem`, `tests/test_rate_limit.py` (429 в RFC7807).
