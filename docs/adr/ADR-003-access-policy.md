# ADR-003: Политика доступа — публичное чтение, owner-only запись
Дата: 2025-10-23
Статус: Accepted

## Context
Продуктовая политика сервиса: данные целей и ключевых результатов можно читать публично (без авторизации), но создавать/изменять/удалять — только будучи авторизованным пользователем и только свои записи. Нужно зафиксировать это правило как основу AuthN/AuthZ и отразить в коде и тестах.

## Decision
- Чтение (GET): публично для `/objectives`, `/objectives/{id}`, `/key-results`, `/key-results/{id}`.
  *Требование:* модели в публичных ответах не содержат PII/секретов.
- Запись (POST/PUT/PATCH/DELETE): требуется токен; операции разрешены только, если `user_id` в запросе совпадает с `sub` из токена (owner-only).
- Аудит и логирование: для всех write-операций логируем `actor`, `method`, `path`, `outcome` (`allow/deny`), при ошибках — `correlation_id`.
- Тесты: позитивные (создание “своё”), негативные (попытка изменения “чужого”), публичное чтение без токена.

## Alternatives
- Всё приватно (чтение только по токену): сложнее онбординг/интеграции, нет нужды по требованиям.
- Полностью открытая запись: неприемлемо по безопасности.

## Consequences
Плюсы: простая модель доступа; предсказуемые API-контракты; минимум трения для чтения.
Минусы: часть данных доступна анонимно, требуется дисциплина минимизации полей в публичных ответах.

## Security impact
- Защита от неавторизованных модификаций (owner-only на записи).
- Снижение риска утечки — за счёт минимального состава публичных полей.

## Rollout plan / DoD
- Обновить middleware/роуты: GET — публично; write — по токену с owner-check.
- DoD: тесты на публичное чтение проходят; попытки записи “не себе” → 403; ошибки в формате RFC 7807.

## Links
- NFR: NFR-01 (Все защищённые эндпоинты требуют действительного токена (кроме `/healthz`), NFR-02 (Пользователь может работать только со своими Objective/KeyResult), NFR-05 (RFC7807), NFR-09 (аудит/логирование).
- Тесты: test_errors::test_create_key_result_forbidden_wrong_user(), test_success::test_create_key_result_success(), test_auth::test_create_objective_unauthorized(), test_auth::test_create_key_result_unauthorized(), test_success::test_create_and_get_objective_success(), test_success::test_create_key_result_success()
