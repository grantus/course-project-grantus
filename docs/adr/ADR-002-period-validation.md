# ADR-002: Нормализация и валидация `period`
Дата: 2025-10-23
Статус: Accepted

## Context
`Objective.period` — дедлайн. По NFR дата не в прошлом. Нужна нормализация в UTC/ISO-8601, чтобы исключить ошибки TZ/DST и обеспечить корректность агрегатов `/stats`.

## Decision
- Принимаем `period` как `date`; внутренне нормализуем к `00:00:00Z` (UTC).
- Валидация: `today ≤ period`.
- Дублируем проверку на уровне pydantic-схемы и бизнес-логики (defence in depth).
- Возвращаем даты в ISO-8601 `YYYY-MM-DD`.

## Alternatives
- Принимать произвольные TZ (усложняет контракт/тесты) — отказ.
- Хранить локальное время пользователя (ошибки при DST) — отказ.

## Consequences
Плюсы: стабильные агрегаты `/stats`.

## Security impact
Снижение рисков логических ошибок дат и искажений в агрегатах. При публичном чтении наружу не попадут явно некорректные значения.

## Rollout plan / DoD
- Feature-flag `FEATURE_PERIOD_VALIDATION=true`; миграция при необходимости.
- DoD: 100% некорректных дат → 422; unit/контракт-тесты зелёные; соответствующая строка в матрице трассировки закрыта.

## Links
- NFR-04 (валидация period)
- RISKS: R6 — логические ошибки `period` (прошлая дата) — снижаем нормализацией к UTC и валидацией `today ≤ period`; R10 — утечка/искажение данных через `/stats` — смягчаем корректной фильтрацией и консистентностью дат.
- Тесты: test_error::test_create_key_result_error_validation_period_past(), test_error::test_create_objective_error_validation_period_past()
